# Mysql Change Data Capture (CDC) - on Fluvio Streaming Platform

The following application translates Mysql table changes into events that can be used for database replication, audit trails, or any other type real-time data processing.

## Requirements

* Access to a Fluvio installation (local or cloud)
    * [Setup Fluvio Cloud](https://app.fluvio.io/login)

* (Laptop Demo) with 2 mysql instances running on same machine:
    * [Setup Producer/Consumer Environment](./docker/README.MD)


## Build Producer/Consumer

In **mysql-cdc** directory, build producer/consumer

```
$ cargo build
...
   Compiling cdc-producer v0.1.0 (/projects/github/rust-demo-apps/mysql-cdc/cdc-producer)
   Compiling cdc-consumer v0.1.0 (/projects/github/rust-demo-apps/mysql-cdc/cdc-consumer)
    Finished dev [unoptimized + debuginfo] target(s) in 1m 21s
```

## Start CDC Producer

**None**: Producer must be started before Consumer, as the producer creates the topic in Fluvio.

Start producer:

```
./target/debug/cdc-producer ./cdc-producer/producer_profile.toml
```

## Start CDC Consumer

Start consumer:

```
./target/debug/cdc-consumer cdc-consumer/consumer_profile.toml 
```

## Connect to Mysql

In two separate terminal windows, connect to the mysql databases

### Connect to Producer (master db)

Docker [installation](./docker/README.MD) maps producer to port 3080.

```
$ mysql -h 0.0.0.0 -P 3080 -ufluvio -pfluvio4cdc!
...
mysql >
```

Producer profile has a filter that registers only changes applied to the "flvDB" database. Let's create the database:

```
mysql> CREATE DATABASE flvDb;
Query OK, 1 row affected (0.01 sec)

mysql> use flvDb;
Database changed
```

### Connect to Consumer (slave db)

Docker [installation](./docker/README.MD) maps consumer to port 3090.

```
$ mysql -h 0.0.0.0 -P 3090 -ufluvio -pfluvio4cdc!
...
mysql >
```

NOTE: The database has been crated the by the cdc-producer (check the log).

Let's take a look:
```
mysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| flvDb              |
| information_schema |
+--------------------+
2 rows in set (0.00 sec)

mysql> use flvDb;
Database changed
```

## MYSQL Test Commands

In the producer terminal, generate mysql commands and see then propagated to the consumer database;

### Consumer

```
mysql> CREATE TABLE pet (name VARCHAR(20), owner VARCHAR(20), species VARCHAR(20), sex CHAR(1), birth DATE);
Query OK, 0 rows affected (0.03 sec)

mysql> show tables;
+-----------------+
| Tables_in_flbDb |
+-----------------+
| pet             |
+-----------------+
1 row in set (0.00 sec)
```

### Producer

Create table has been propagated to the consumer:

```
mysql> show tables;
+-----------------+
| Tables_in_flbDb |
+-----------------+
| pet             |
+-----------------+
1 row in set (0.00 sec)
```

## Sample MYSQL Commands

For additional mysql commands, checkout [MYSQL-COMMANDS](./MYSQL-COMMANDS.MD)

## Fluvio Events

CDC producer generates the events on the **Fluvio topic** as defined in the producer profile. By default the topic name is **rust-mysql-cdc**. 

To view the events generated by the CDC producer, start run **fluvio consumer** command:

```
$ ./target/debug/fluvio consume rust-mysql-cdc -B
...
{"uri":"flv://mysql-srv1/flvDb/year","sequence":30,"bn_file":{"fileName":"binlog.000003","offset":10650},"columns":["y"],"operation":{"Add":{"rows":[{"cols":[{"Year":1998}]}]}}}
{"uri":"flv://mysql-srv1/flvDb/year","sequence":31,"bn_file":{"fileName":"binlog.000003","offset":10921},"columns":["y"],"operation":{"Add":{"rows":[{"cols":[{"Year":1999}]}]}}}
{"uri":"flv://mysql-srv1/flvDb/year","sequence":32,"bn_file":{"fileName":"binlog.000003","offset":11192},"columns":["y"],"operation":{"Delete":{"rows":[{"cols":[{"Year":1998}]},{"cols":[{"Year":1999}]}]}}}
```